#!/bin/bash

set -e

PACK_NAME="opencode-csp-plan-cook-pack"
PACK_VERSION="1.0.0"
MANIFEST_FILE=".opencode/.${PACK_NAME}.manifest"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

show_usage() {
    cat << EOF
Usage: $0 [OPTIONS]

Install OpenCode CSP-Plan Cook Pack

OPTIONS:
    -p, --path PATH    Target project path (default: current directory)
    -f, --force        Force reinstall (remove existing symlinks first)
    -h, --help         Show this help message

EXAMPLES:
    $0                              # Install in current directory
    $0 -p /path/to/project         # Install in specific directory
    $0 -p /path/to/project -f     # Force reinstall

EOF
}

# Parse arguments
TARGET_PATH="$(pwd)"
FORCE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--path)
            TARGET_PATH="$2"
            shift 2
            ;;
        -f|--force)
            FORCE=true
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            log_error "Unknown option: $1"
            show_usage
            exit 1
            ;;
    esac
done

# Resolve absolute path
TARGET_PATH="$(cd "$TARGET_PATH" 2>/dev/null && pwd)"
PACK_DIR="$(cd "$(dirname "$0")/.." && pwd)"

if [ -z "$TARGET_PATH" ] || [ ! -d "$TARGET_PATH" ]; then
    log_error "Invalid target path: $TARGET_PATH"
    exit 1
fi

if [ "$TARGET_PATH" = "$PACK_DIR" ]; then
    log_error "Refusing to install into the pack repository itself."
    log_error "Please provide your project path with -p, for example:"
    log_error "  ./bin/install.sh -p ../my-project"
    exit 1
fi

log_info "Installing ${PACK_NAME} v${PACK_VERSION} to: ${TARGET_PATH}"
log_info "Pack directory: ${PACK_DIR}"

# Check if target is a git repository
if [ ! -d "$TARGET_PATH/.git" ] && [ ! -f "$TARGET_PATH/opencode.json" ]; then
    log_warn "Target directory is not a git repo or doesn't have opencode.json"
    log_warn "Installation will continue but it's recommended to use in a project"
fi

# Create .opencode directory if not exists
OPENCODE_DIR="$TARGET_PATH/.opencode"
if [ ! -d "$OPENCODE_DIR" ]; then
    mkdir -p "$OPENCODE_DIR"
    log_info "Created .opencode directory"
fi

# Initialize manifest
MANIFEST_PATH="$TARGET_PATH/$MANIFEST_FILE"
echo "# ${PACK_NAME} v${PACK_VERSION} - Installed $(date -Iseconds)" > "$MANIFEST_PATH"
echo "# DO NOT EDIT THIS FILE MANUALLY" >> "$MANIFEST_PATH"

error_count=0

# Function to create symlink with backup
create_symlink() {
    local source="$1"
    local target="$2"
    local relative_path="$3"
    
    local target_dir
    target_dir=$(dirname "$target")
    
    # Create target directory if not exists
    if [ ! -d "$target_dir" ]; then
        mkdir -p "$target_dir"
    fi
    
    # Remove existing file/symlink if exists
    if [ -e "$target" ] || [ -L "$target" ]; then
        if [ "$FORCE" = true ]; then
            rm -rf "$target"
            log_warn "Removed existing: $target"
        else
            if [ -L "$target" ]; then
                local existing_target
                existing_target=$(readlink -f "$target")
                if [ "$existing_target" = "$source" ]; then
                    log_info "Symlink already exists and points to correct source: $target"
                    echo "$relative_path" >> "$MANIFEST_PATH"
                    return 0
                fi
            fi
            log_error "Target already exists: $target (use --force to overwrite)"
            return 1
        fi
    fi
    
    # Create symlink
    ln -s "$source" "$target"
    log_info "Created symlink: $target -> $source"
    echo "$relative_path" >> "$MANIFEST_PATH"
}

# Install skills
log_info "Installing skills..."
SKILLS_DIR="$PACK_DIR/.opencode/skills"
if [ -d "$SKILLS_DIR" ]; then
    for skill_dir in "$SKILLS_DIR"/*; do
        if [ -d "$skill_dir" ]; then
            skill_name=$(basename "$skill_dir")
            source_path="$skill_dir"
            target_path="$OPENCODE_DIR/skills/$skill_name"
            relative_path="skills/$skill_name"
            
            if create_symlink "$source_path" "$target_path" "$relative_path"; then
                log_info "  - $skill_name"
            else
                error_count=$((error_count + 1))
            fi
        fi
    done
fi

# Install agents
log_info "Installing agents..."
AGENTS_DIR="$PACK_DIR/.opencode/agents"
if [ -d "$AGENTS_DIR" ]; then
    for agent_file in "$AGENTS_DIR"/*.md; do
        if [ -f "$agent_file" ]; then
            agent_name=$(basename "$agent_file" .md)
            source_path="$agent_file"
            target_path="$OPENCODE_DIR/agents/$agent_name.md"
            relative_path="agents/$agent_name.md"
            
            if create_symlink "$source_path" "$target_path" "$relative_path"; then
                log_info "  - $agent_name"
            else
                error_count=$((error_count + 1))
            fi
        fi
    done
fi

# Install commands
log_info "Installing commands..."
COMMANDS_DIR="$PACK_DIR/.opencode/commands"
if [ -d "$COMMANDS_DIR" ]; then
    for cmd_file in "$COMMANDS_DIR"/*.md; do
        if [ -f "$cmd_file" ]; then
            cmd_name=$(basename "$cmd_file" .md)
            source_path="$cmd_file"
            target_path="$OPENCODE_DIR/commands/$cmd_name.md"
            relative_path="commands/$cmd_name.md"
            
            if create_symlink "$source_path" "$target_path" "$relative_path"; then
                log_info "  - $cmd_name"
            else
                error_count=$((error_count + 1))
            fi
        fi
    done
fi

if [ "$error_count" -gt 0 ]; then
    log_error "Installation failed with $error_count error(s)."
    log_error "Nothing was overwritten. Use --force to replace conflicting files."
    exit 1
fi

log_info ""
log_info "============================================"
log_info "Installation complete!"
log_info ""
log_info "Available commands:"
log_info "  /csp-plan <task>  - Lap ke hoach phan tich"
log_info "  /cook <task>    - Thuc thi task"
log_info ""
log_info "Available agents:"
log_info "  csp-plan (Tab -> chon)"
log_info "  cook (Tab -> chon)"
log_info ""
log_info "Available skills:"
log_info "  plan-writing"
log_info "  coding-standard"
log_info "  test-strategy"
log_info ""
log_info "To update: ./bin/update.sh -p ${TARGET_PATH}"
log_info "To uninstall: ./bin/uninstall.sh -p ${TARGET_PATH}"
log_info "============================================"
